!function(t){"object"==typeof exports?module.exports=t(require("backbone"),require("underscore")):"function"==typeof define&&define.amd&&define(["backbone","underscore"],t)}(function(t,e){return t.Validation=function(e){"use strict";var n={forceUpdate:!1,selector:"name",labelFormatter:"sentenceCase",valid:Function.prototype,invalid:Function.prototype},r={formatLabel:function(t,e){return c[n.labelFormatter](t,e)},format:function(){var t=Array.prototype.slice.call(arguments),e=t.shift();return e.replace(/\{(\d+)\}/g,function(e,n){return"undefined"!=typeof t[n]?t[n]:e})}},i=function(n,r,s){return r=r||{},s=s||"",e.each(n,function(e,o){n.hasOwnProperty(o)&&(!e||"object"!=typeof e||e instanceof Date||e instanceof RegExp||e instanceof t.Model||e instanceof t.Collection?r[s+o]=e:i(e,r,s+o+"."))}),r},s=function(){var t=function(t){return e.reduce(e.keys(t.validation||{}),function(t,e){return t[e]=void 0,t},{})},s=function(t,n){var r=t.validation?t.validation[n]||{}:{};return(e.isFunction(r)||e.isString(r))&&(r={fn:r}),e.isArray(r)||(r=[r]),e.reduce(r,function(t,n){return e.each(e.without(e.keys(n),"msg"),function(e){t.push({fn:l[e],val:n[e],msg:n.msg})}),t},[])},u=function(t,n,i,o,u){var a=s(n,i);if(0===a.length)t.resolve();else{var c=function(s){var h=$.Deferred();h.promise().then(function(){var e=a.shift();return e?c(e):(t.resolve(),void 0)},function(){t.reject(s.msg)});try{var f=e.extend({},r,l);s.fn.call(f,h,o,i,s.val,n,u)}catch(d){t.reject(s.msg)}};c(a.shift())}return t.promise()},a=function(t,n){var r=$.Deferred(),s={},o=!0,a=e.clone(n),c=i(n),l=e.pairs(c),h=function(e){var n=e[0],i=e[1],c=$.Deferred();c.promise().then(function(){var t=l.shift();return t?h(t):(r.resolve({invalidAttrs:s,isValid:o}),void 0)},function(t){s[n]=t,o=!1;var e=l.shift();return e?h(e):(r.resolve({invalidAttrs:s,isValid:o}),void 0)}),u(c,t,n,i,a)};return h(l.shift()),r.promise()},c=function(n,r){return{preValidate:function(t,n){return u($.Deferred(),this,t,n,e.extend({},this.attributes))},isValid:function(t){var n=i(this.attributes);return e.isString(t)?!u(this,t,n[t],e.extend({},this.attributes)):e.isArray(t)?e.reduce(t,function(t,r){return t&&!u(this,r,n[r],e.extend({},this.attributes))},!0,this):(t===!0&&this.validate(),this.validation?this._isValid:!0)},validate:function(s,o){var u=this,c=!s,l=e.extend({},r,o),h=t(u),f=e.extend({},h,u.attributes,s),d=i(s||f),p=$.Deferred();return a(u,f).then(function(t){return u._isValid=t.isValid,e.each(h,function(e,r){var i=t.invalidAttrs.hasOwnProperty(r);i||l.valid(n,r,l.selector)}),e.each(h,function(e,r){var i=t.invalidAttrs.hasOwnProperty(r),s=d.hasOwnProperty(r);i&&(s||c)&&l.invalid(n,r,t.invalidAttrs[r],l.selector)}),e.defer(function(){u.trigger("validated",u._isValid,u,t.invalidAttrs),u.trigger("validated:"+(u._isValid?"valid":"invalid"),u,t.invalidAttrs)}),!l.forceUpdate&&e.intersection(e.keys(t.invalidAttrs),e.keys(d)).length>0?t.invalidAttrs:(u._isValid?p.resolve():p.reject(),void 0)}),p.promise()}}},h=function(t,n,r){e.extend(n,c(t,r))},f=function(t){delete t.validate,delete t.preValidate,delete t.isValid},d=function(t){h(this.view,t,this.options)},p=function(t){f(t)};return{version:"0.8.0",configure:function(t){e.extend(n,t)},bind:function(t,r){var i=t.model,s=t.collection;if(r=e.extend({},n,o,r),"undefined"==typeof i&&"undefined"==typeof s)throw"Before you execute the binding your view must have a model or a collection.\nSee http://thedersen.com/projects/backbone-validation/#using-form-model-validation for more information.";i?h(t,i,r):s&&(s.each(function(e){h(t,e,r)}),s.bind("add",d,{view:t,options:r}),s.bind("remove",p))},unbind:function(t){var e=t.model,n=t.collection;e&&f(t.model),n&&(n.each(function(t){f(t)}),n.unbind("add",d),n.unbind("remove",p))},mixin:c(null,n)}}(),o=s.callbacks={valid:function(t,e,n){t.$("["+n+'~="'+e+'"]').removeClass("invalid").removeAttr("data-error")},invalid:function(t,e,n,r){t.$("["+r+'~="'+e+'"]').addClass("invalid").attr("data-error",n)}},u=s.patterns={digits:/^\d+$/,number:/^-?(?:\d+|\d{1,3}(?:,\d{3})+)(?:\.\d+)?$/,email:/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))$/i,url:/^(https?|ftp):\/\/(((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?(((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?)(:\d*)?)(\/((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)?(\?((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(\#((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/i},a=s.messages={required:"{0} is required",acceptance:"{0} must be accepted",min:"{0} must be greater than or equal to {1}",max:"{0} must be less than or equal to {1}",range:"{0} must be between {1} and {2}",length:"{0} must be {1} characters",minLength:"{0} must be at least {1} characters",maxLength:"{0} must be at most {1} characters",rangeLength:"{0} must be between {1} and {2} characters",oneOf:"{0} must be one of: {1}",equalTo:"{0} must be the same as {1}",pattern:"{0} must be a valid {1}"},c=s.labelFormatters={none:function(t){return t},sentenceCase:function(t){return t.replace(/(?:^\w|[A-Z]|\b\w)/g,function(t,e){return 0===e?t.toUpperCase():" "+t.toLowerCase()}).replace("_"," ")},label:function(t,e){return e.labels&&e.labels[t]||c.sentenceCase(t,e)}},l=s.validators=function(){var t=String.prototype.trim?function(t){return null===t?"":String.prototype.trim.call(t)}:function(t){var e=/^\s+/,n=/\s+$/;return null===t?"":t.toString().replace(e,"").replace(n,"")},n=function(t){return e.isNumber(t)||e.isString(t)&&t.match(u.number)},r=function(n){return!(e.isNull(n)||e.isUndefined(n)||e.isString(n)&&""===t(n))};return{fn:function(t,n,r,i,s,o){return e.isString(i)&&(i=s[i]),i(t,s,n,r,o)},required:function(t,n,i,s,o,u){var c=e.isFunction(s)?s.call(o,n,i,u):s;if(!c&&!r(n))return t.resolve();if(c&&!r(n)){var l=this.format(a.required,this.formatLabel(i,o));return t.reject(l)}return t.resolve()},acceptance:function(t,n,r,i,s){return"true"===n||e.isBoolean(n)&&n!==!1?t.resolve():t.reject(this.format(a.acceptance,this.formatLabel(r,s)))},min:function(t,e,r,i,s){return!n(e)||i>e?t.reject(this.format(a.min,this.formatLabel(r,s),i)):t.resolve()},max:function(t,e,r,i,s){return!n(e)||e>i?t.reject(this.format(a.max,this.formatLabel(r,s),i)):t.resolve()},range:function(t,e,r,i,s){return!n(e)||e<i[0]||e>i[1]?t.reject(this.format(a.range,this.formatLabel(r,s),i[0],i[1])):t.resolve()},length:function(e,n,i,s,o){return r(n)&&t(n).length===s?e.resolve():e.reject(this.format(a.length,this.formatLabel(i,o),s))},minLength:function(e,n,i,s,o){return!r(n)||t(n).length<s?e.reject(this.format(a.minLength,this.formatLabel(i,o),s)):e.resolve()},maxLength:function(e,n,i,s,o){return!r(n)||t(n).length>s?e.reject(this.format(a.maxLength,this.formatLabel(i,o),s)):e.resolve()},rangeLength:function(e,n,i,s,o){return!r(n)||t(n).length<s[0]||t(n).length>s[1]?e.reject(this.format(a.rangeLength,this.formatLabel(i,o),s[0],s[1])):e.resolve()},oneOf:function(t,n,r,i,s){return e.include(i,n)?t.resolve():t.reject(this.format(a.oneOf,this.formatLabel(r,s),i.join(", ")))},equalTo:function(t,e,n,r,i,s){return e!==s[r]?t.reject(this.format(a.equalTo,this.formatLabel(n,i),this.formatLabel(r,i))):t.resolve()},pattern:function(t,e,n,i,s){return r(e)&&e.toString().match(u[i]||i)?t.resolve():t.reject(this.format(a.pattern,this.formatLabel(n,s),i))}}}();return s}(e),t.Validation});