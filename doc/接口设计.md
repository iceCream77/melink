车货交易平台接口设计
====================

## 1.接口访问规范

1. 接口访问遵循 RESTful 规范
2. token在请求头中传递，除非特别注明，其它接口都必须传入token
3. 返回的数据采用json格式

### 1.1 接口返回错误代码
见错误代码部分
	
	
### 1.2 接口返回数据格式

#### 1.2.1. 请求失败

		{
			"result":0,
			"errors":{
				"code":"error_code", 
				"message":"错误信息"
			}
		}
			
#### 1.2.2. 请求成功
1. 不需要返回数据的
				
			{
				"result":1
			}	
				
2. 返回单条数据
		
			{
				"result":1,
				"data":{
					"key1":"value1",
					"key2":"value2",
					...
				}
				
			}

3. 返回多条数据
		
			{
				"result":1,
				"data":[
					{
						"key1":"value1",
						"key2":"value2",
						...
					},
					{
						"key1":"value1",
						"key2":"value2",
						...
					},
					...
				]
			}

### 1.3 MeFP portal
	
	统一认证 MeFP portal开发完成,具体的接口参阅<统一认证接口文档.md>

#### 1.3.1 登录与访问本App 

	1. 前端输入用户密码
	2. 提交到本App的/users/login 接口
	3. /users/login 接口访问MeFP portal的用户认证接口,返回认证结果
	4. 认证通过后,根据login_name在本App的数据库表 users 中查找记录
	5. 生成token,作为/users/login接口的返回值.
	6. 前端获取 token,encodingURI编码后,记录在cookie中,设定过期时间
	7. 在访问本App的其它接口时,从cookie中获取token,decodingURI后添加到RequestHead中
		
#### 1.3.2 访问其它App

	1. 调用 MeFP portal 的/ auth/token 接口
	2. 认证通过后,会获取到其它App的token
	3. 前端获取 token,encodingURI编码后,记录在cookie中,设定过期时间
	4. 在访问其它App时,从cookie中获取token,decodingURI后添加到RequestHead中
		
### 2.接口清单
#### 2.1 用户 /users
序号		|接口名称  |请求方式|说明
------:|--------|-------------------|------------------
 1|[/users/login](#login)				|POST	|登录
 2|[/users/register](#register)		|POST	|注册用户,用户在MeFP中不存在
 3|[/users/activate](#activate)		|POST	|激活用户,用户在MeFP中已存在
 4|[/users/:id](#update_user)		|PUT 	|修改用户信息，修改密码，停用、启用等
 5|[/users/:id](#user_info)			|GET 	|获取用户详情
 6|[/users](#userlist)				|GET 	|获取用户列表
 7|[/users/token](#token)				|POST	|为其它App提交接口,仅供MeFP访问
 
#### 2.2 货源 /cargos

序号		|接口名称  |请求方式|说明
------:|--------|-------------------|------------------
 1|[/cargos](#add_cargo)				|POST 	|发布货源
 2|[/cargos](#cargo_list)				|GET 	|获取货源列表
 3|[/cargos/:id](#view_cargo)		|GET 	|获取货源详情
 4|[/cargos/:id](#update_cargo)		|PUT 	|修改货源
 5|[/cargos/:id](#del_cargo)			|DELETE	|删除货源 
 6|[/cargos/:id/status](#cargos_status)	|GET |获取货单状态
 
#### 2.3 电话沟通记录 /calllogs

序号		|接口名称  |请求方式|说明
------:|--------|-------------------|------------------
 1|[/calllogs](#add_call)				|POST 	|添加电话沟通交易
 2|[/calllogs](#call_list)			|GET 	|交易列表

#### 2.4 车货交易 /trades

序号		|接口名称  |请求方式|说明
------:|--------|-------------------|------------------
 1|[/trades](#add_trade)				|POST 	|生成交易
 2|[/trades](#trade_list)				|GET 	|交易列表
 3|[/trades/:id](#view_trade)		|GET 	|交易详情
 4|[/trades/:id](#update_trade)		|POST 	|修改交易信息
 5|[/trades/:id/logs](#add_tradelog)|POST	|添加交易记录 
 6|[/trades/:id/status](#trades_status)	|GET |获取订单状态信息
 7|[/trades/:id/cancel](#trades_cancel)	|DELETE|取消订单信息
 8|[/trades/:id/logs](#trade_log)	|GET	|获取指定交易的交易记录 

#### 2.4 车辆 /cars

序号		|接口名称  |请求方式|说明
------:|--------|-------------------|------------------
 1|[/cars](#cars_list)				|GET 	|车辆列表,从melink获取
 2|[/cars/:id](#view_car)				|GET 	|车辆详情,从melink获取  
 3|[/cars/:id/status](#get_status)	|GET 	|获取车辆状态,须melink修改
 4|[/cars/:id/status](#put_status)	|PUT 	|设置车辆状态,须melink修改

#### 2.5 车辆位置 /locations

序号		|接口名称  |请求方式|说明
------:|--------|-------------------|------------------
 1|[/locations](#add_location)		|GET 	|添加车辆位置
 2|[/locations](#list_location)		|GET 	|获取车辆位置列表 

#### 2.5 消息推送 /message

序号		|接口名称  |请求方式|说明
------:|--------|-------------------|------------------
 1|[/message/sms](#sms)				|POST|推送短信
 2|[/message/app](#app)				|POST|app推送
 3|[/message/weixin](#weixin)		|POST|微信推送
 4|[/message](#message)				|GET |获取推送信息列表
 5|[/message/sms/count](#sms_count)	|GET |当日免费短信剩余
 
#### 2.6 上传文件 /uploads

序号		|接口名称  |请求方式|说明
------:|--------|-------------------|------------------
 1|[/uploads/](#add_uploads)			|POST|生成上传附件
 2|[/uploads/](#list_uploads)		|GET |获取附件列表
 3|[/uploads/:id](#update_uploads)	|PUT |修改附件信息
 4|[/uploads/:id](#get_uploads)		|GET |获取附件信息
 
###2. 接口设计


#### 1. <label id="login">用户登录</label>

|方法名称|/users/login|
|:----|:--------|
|请求方式|POST|

|参数名称|可空|说明|
|:--|:--------|
|login_name|N|登录名,目前的Login_name为手机号码|
|password|N|联系人姓名|

说明:

	根据用户与密码,加密后提交到 MeFP_Protal/auth/login
	
	根据返回值处理
		返回失败:返回错误信息
		
	验证通过,在users表中根据login_name查找
		查找不到,说明该用户未激活,前端提示并转到激活页面
		
	获取将查找到的信息,将
		login_name,
		user_name,
		role,
		area,
		reg_time,
		checked,
		status,
		expired_time(过期时间,当前时间加一天),
	用AESC加密后再用Base64加密,作为token


返回数据:
>
	{
		"result":1,
		"data":{
			"token":"xxxxxxxxxxxxxxxxx",
			"login_name":"13812345678",
			"user_id":123,
			"user_name":"张三",
			"role":0,
			"checked":1,
			"status":1,
			"reg_time":"2015-01-01 12:30:00",
			"login_time":"2015-03-01 12:30:00",//上次登录时间
			"login_ip":"10.10.10.10",			//上次登录ip
			"login_count":10,					//登录次数
			"sign":"这个家伙很懒,什么也没有留下"
		}
	}

#### 2. <label id="register">用户注册</label>

|方法名称|/users/register|
|:----|:--------|
|请求方式|POST|

|参数名称|可空|说明|
|:--|:--------|
|login_name|N|登录名|
|password|N|密码|
|captcha|N|手机验证码|
|user_name||昵称|
|city||所在城市|
|sign||签名档|
|memo||备注信息|

说明:

	组织参数 login_name,password,captcha,向 MeFP_Portal/auth/register 发起请求
	返回成功后,将login_name,user_name,city,sign,memo,reg_time(当前时间)等入到数据库表users中
	
	users表中area字段可空,配合role作为合作方的扩展
	合作方下属的用户为 area like '{area}%' and role <{role}


返回数据:
>
	{
		"result":1
	}

#### 3. <label id="activate">用户激活</label>

|方法名称|/users/activate|
|:----|:--------|
|请求方式|POST|

|参数名称|可空|说明|
|:--|:--------|
|login_name|N|登录名|
|user_name|N|昵称|
|city|N|所在城市|
|sign|N|签名档|
|memo|N|备注信息|

说明:

	向 MeFP_Portal/auth/check 发起请求,确认用户存在后
	将login_name,user_name,city,sign,memo,reg_time(当前时间)等添加到数据库表users中
	

返回数据:
>
	{
		"result":1
	}

#### 4. <label id="update_user">用户修改</label>

|方法名称|/users/:id|
|:----|:--------|
|请求方式|PUT|

|参数名称|可空|说明|
|:--|:--------|
|user_name| |昵称|
|city| |所在城市|
|sign| |签名档|
|memo| |备注信息|

说明:

	修改 users 中相应的字段
	

返回数据:
>
	{
		"result":1
	}

#### 5. <label id="user_info">用户详情</label>

|方法名称|/users/:id|
|:----|:--------|
|请求方式|GET|

|参数名称|可空|说明|
|:--|:--------|
|keyword||关键字模糊查询,匹配login_name,user_name,city,sign,memo|
|role| |角色|
|status| |状态|
|checked| |审核状况|

返回数据:
>
	{
		"result":1,
		"data":{
			"login_name":"13812345678",
			"user_id":123,
			"user_name":"张三",
			"idcard_number":"3303198011221234",
			"role":0,
			"city":"杭州",
			"area":"浙江-杭州",
			"status":1,
			"checked":1
			"reg_time":"2015-01-01 12:30:00",
			"login_time":"2015-03-01 12:30:00",
			"login_ip":"10.10.10.10",
			"login_count":10,
			"sign":"这个家伙很懒,什么也没有留下",
			"memo":"备注信息",
			"consignors":{
				"contact_number":"货方联系电话",
				"contact_name":"货方联系人",
				"company":"公司名",
				"address":"地址",
				"memo":"货方备注信息",
				"img_idcard":"idcard/123.jpg"
				"img_org":"org/123.jpg",
				"img_biz":"biz/123.jpg",
			},
			"drivers":{
				"contact_number":"货方联系电话",
				"contact_name":"货方联系人",
				"plate_number":"车牌",
				"location":"最新位置",
				"lng":119.12345,
				"lat":38.123456,
				"memo":"车方备注",
				"img_idcard":"idcard/123.jpg",
				"img_car":"car/123.jpg"		
				"img_driver":"drvier/123.jpg"
				"img_driving":"driving/123.jpg"
				"img_opt":"opt/123.jpg"
			}
		}
	}

#### 6. <label id="userlist">用户列表</label>

|方法名称|/users/:id|
|:----|:--------|
|请求方式|GET|


返回数据:
>
	{
		"result":1,
		"data":[
			{
				"login_name":"13812345678",
				"user_id":123,
				"user_name":"张三",
				"role":0,
				"city":"杭州",
				"area":"区域",
				"checked":1,
				"status":1,
				"consignors":{
					"contact_number":"货方联系电话",
					"contact_name":"货方联系人",
					"company":"公司名",
					"address":"地址",
					"app_id":"货主端appid"
				},
				"drivers":{
					"contact_number":"货方联系电话",
					"contact_name":"货方联系人",
					"plate_number":"车牌",
					"location":"最新位置",
					"lng":119.12345,
					"lat":38.123456,
					"app_id":"车主端appid"
				}
			}
		]
	}

#### 7. <label id="token">为MeFP提供的 token</label>

|方法名称|/users/:id|
|:----|:--------|
|请求方式|POST|
|说明|传入与输出的内容都须经过加密|

|参数名称|可空|说明|
|:--|:--------|
|login_name||登录名|

说明:
	
	本接口不对外开放,只允许MeFP访问,要做IP限制,IP要写在配置文件中
	本接口接收与返回的数据均为加密数据
	
	接收的数据先进行Base64解密,然后用AES解密,AES加密所需要的密钥写在配置文件,
		mefp.scret为32位密钥
		app.scret为16位密钥,作为初始向量
		
	返回的数据,先经AES加密,然后再经Base64加密.
	返回的数据格式参阅<统一验证接口文档.md>
	
传入的数据解密后:
>
	{
		"login_name":"13812345678"
	}

返回数据加密前:
>
	{
		"token":"xxxxxxxxxxxxxxxxxxx"
	}

#### 1. <label id="add_cargo">发布货源</label>

|方法名称|/cargos|
|:----|:--------|
|请求方式|POST|

|参数名称|可空|说明|
|:--|:--------|
|login_name|N|发货用户的登录名|
|title|N|货货名称,长度不超过200个字符|
|origin_city|N|启运地所在城市(地级市)|
|origin_addr||启运地详细地址|
|origin_lng||启运地经度(从百度地图API中获取)|
|origin_lat||启运地纬度(从百度地图API中获取)|
|destin_city|N|抵达地所在城市(地级市)|
|destin_addr||抵达地详细地址|
|destin_lng||抵达地经度(从百度地图API中获取)|
|destin_lat||抵达地纬度(从百度地图API中获取)|
|load_time||装货时间|
|ref_distance||参考货运距离(根据百度地图导航数据,获取默认线路的总距离)|
|ref_carriage||参考运费,根据距离与车型计算,具体计算方式另外给出|
|carriage||运费(即货方运费报价)|
|weight||重量|
|volume||体积|
|length||货长|
|car_length||所需车长|
|car_model||所需车型,平板,高栏等|
|sender_name||发货方联系人姓名|
|sender_phone||发货方联系电话|
|receiver_name||收货方联系人姓名|
|receiver_phone||收货方联系电话|
|status||状态,货单状态,0已取消,10未成交(默认),20待成交(车找货),30待成交(货找车),99已成交|
|voice||语音文件路径与文件名|
|img||图片文件路径与文件名|
|attch||附件路径与文件名,只允许一个附件,多个附件建议压缩成一个包,留作以后扩展用|
|memo||所需车型,平板,高栏等|

说明:

	附件,图片,语音等,前端实现时,先调用上传的接口,上传成功返回相应的文件名

返回数据:
>
	{
		"result":1
	}
	
#### 2. <label id="cargo_list">货源列表</label>

|方法名称|/cargos|
|:----|:--------|
|请求方式|GET|

|参数名称|可空|说明|
|:--|:--------|
|login_name||发货用户的登录名|
|origin_city||启运地所在城市(地级市)|
|destin_city||抵达地所在城市(地级市)|
|publish_time_from||发布时间,查询参数 publish_time>={publish_time_from}|
|publish_time_to||发布时间,查询参数 publish_time<={publish_time_to}|
|weight_from||重量,查询参数|
|weight_to||重量,查询参数|
|volume_from||体积,查询参数|
|volume_to||体积,查询参数|
|length_from||长度,查询参数|
|legnth_to||长度,查询参数|
|car_length_from||车长,查询参数|
|car_legnth_to||车长,查询参数|
|car_model||所需车型|
|status||货单状态|
|keyword||关键字,从title,origin_addr,destin_addr,sender_name,receiver_name,memo中模糊查找|
|lng||指定位置的经度|
|lat||指定位置的纬度,与经度一起确定指定位置(一般为手机当前定位位置),计算启运地与当前位置的距离|
|orderby||排序字段,time(发布时间),distance(须传入(lng,lat),指定位置与货启运地的距离,ref_distance(参考运输距离),参数前加负号代码降序,无负号为升序,默认为-time,即发布时间降序|


说明:

	附件,图片,语音等,前端实现时,先调用上传的接口,上传成功返回相应的文件名
	排序方式为distance时,必须传入lng与lat,以计算指定位置与启运地的距离,如果启运地的位置由(origin_lng,origin_lat)确定,如果为空或者值错误,该信息将不会出现在结果中.
	为提高查询效率,建议前端指定默认的publish_time_from
	

返回数据:
>
	{
		"result":1
		"data":[
			{
				"login_name":"13812345678",
				"title":"duang~duang~duang~",
				"origin_city":"杭州",
				"origin_addr":"石大物流园",
				"destin_city":"杭州"
				"destin_addr":"传化物流园",
				"load_time":"2015-03-02 12:00:00",
				"weight":5,
				"volume":"",
				"length":"",
				"car_length":4.6,
				"car_model":"CM02",
				"ref_distance":5.1,//参考货运距离
				"distance":10.3,//参考距离,只有传入指定的lng与lat,才会有值
				"ref_carriage":200,
				"carriage":250,
				"sender_name":"张三",
				"sender_phone":"13812345678",
				"receiver_name":"李四",
				"receiver_phone":"13087654321",
				"status":10,
				"voice":"voice/20150302.voc",
				"img":"img/20150302/123.jpg",
				"attch":"attch/20150302/123.zip"
			}
			...
			
		]
	}
	
#### 3. <label id="view_cargo">货源详情</label>

|方法名称|/cargos|
|:----|:--------|
|请求方式|GET|

|参数名称|可空|说明|
|:--|:--------|
|lng||指定位置的经度|
|lat||指定位置的纬度,与经度一起确定指定位置(一般为手机当前定位位置),计算启运地与当前位置的距离|

返回数据:
>
	{
		"result":1
		"data":{
				"login_name":"13812345678",
				"title":"duang~duang~duang~",
				"origin_city":"杭州",
				"origin_addr":"石大物流园",
				"origin_lng":130.123456,
				"origin_lat":36.123456,
				"destin_city":"杭州"
				"destin_addr":"传化物流园",
				"destin_lng":130.123456,
				"destin_lat":36.123456,
				"load_time":"2015-03-02 12:00:00",
				"weight":5,
				"volume":"",
				"length":"",
				"car_length":4.6,
				"car_model":"CM02",
				"ref_distance":5.1,//参考货运距离
				"distance":10.3,//参考距离,只有传入指定的lng与lat,才会有值
				"ref_carriage":200,
				"carriage":250,
				"sender_name":"张三",
				"sender_phone":"13812345678",
				"receiver_name":"李四",
				"receiver_phone":"13087654321",
				"status":10,
				"voice":"voice/20150302.voc",
				"img":"img/20150302/123.amr",
				"attch":"attch/20150302/123.zip",
				"memo":"我是备注信息,乱七八糟的都可以写在这里"
			}
	}
