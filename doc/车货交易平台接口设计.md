车货交易平台接口设计
====================

## 1.接口访问规范

1. 接口访问遵循 RESTful 规范
2. token在请求头中传递，除非特别注明，其它接口都必须传入token
3. 返回的数据采用json格式

### 1.1 接口返回错误代码
见错误代码部分
	
	
### 1.2 接口返回数据格式

#### 1.2.1. 请求失败

		{
			"success":false,
			"error":{
				"code":"error_code", 
				"message":"错误信息"
			}
		}
			
#### 1.2.2. 请求成功
1. 不需要返回数据的
				
			{
				"success":true
			}	
				
2. 返回单条数据
		
			{
				"success":true,
				"result":{
					"key1":"value1",
					"key2":"value2",
					...
				}
				
			}

3. 返回多条数据
		
			{
				"success":true,
				"result":[
					{
						"key1":"value1",
						"key2":"value2",
						...
					},
					{
						"key1":"value1",
						"key2":"value2",
						...
					},
					...
				]
			}

### 1.3 访问应用的方式

	统一认证 MeFP portal开发完成
	登录时，由MeFP portal提供统一的登录接口
	用户输入用户名密码以及要访问的应用，
	MeFP 验证用户名通过，然后向应用获取token,返回token;
	用户以拿到的token访问应用。
	
	应用生成token的接口要做ip验证，只有指定的ip访问才返回token
	token有过期时间，过期后用户要重新获取token才能继续使用。
	
	交易平台中的token数据目前有
	
	* login_name:全局唯一的登录名,目前默认为手机号
	* user_id:本应用中的用户名,可空，如果为空,转到激活页面，要求用户先激活用户
	* expired_time:过期时间，默认的有效时间为一天
	
	
### 1.4 接口清单

序号|接口名称|请求方式|说明
--|--|--|--
0 |[/users/activate](#activate)		|POST|激活用户，注册由MeFP完成
1 |[/users/:id](#update_users)		|PUT |修改用户信息，修改密码，停用、启用等
2 |[/users/:id](#get_users)			|GET |获取用户信息
3 |[/users/token](#token)				|GET |没有token,获取token,否则返回用户信息
4 |[/cargos/](#add_cargos)			|POST|发布货源
5 |[/cargos/](#list_cargos)			|GET |获取货源列表
6 |[/cargos/:id](#update_cargos)		|PUT |修改货源
7 |[/cargos/:id](#get_cargos)		|GET |获取货源信息
8 |* [/cars/](#add_cars)				|POST|发布车辆 melink的功能
9 |* [/cars/](#list_cars)				|GET |获取车辆列表，melink的功能
10|* [/cars/:id](#update_cars)		|PUT |修改车辆，melink的功能
11|* [/cars/:id](#get_cars)			|GET |获取车辆信息，melink的功能
12|* [/cars/:id/locate](#get_locate)|GET |获取车辆位置信息，melink的功能
13|[/cars/:id/status](#get_status)	|GET |获取车辆状态
14|[/cars/:id/status](#put_status)	|PUT |设置车辆状态
15|[/trades/](#add_trades)			|POST|生成订单
16|[/trades/](#list_trades)			|GET |获取订单列表
17|[/trades/:id](#update_trades)		|PUT |修改订单
18|[/trades/:id](#get_trades)		|GET |获取订单信息
19|[/trades/:id/status](#trades_status)	|GET |获取订单信息
20|[/trades/:id/cancel](#trades_cancel)	|DELETE|取消订单信息
21|[/uploads/](#add_uploads)			|POST|生成上传附件
22|[/uploads/](#list_uploads)		|GET |获取附件列表
23|[/uploads/:id](#update_uploads)	|PUT |修改附件信息
24|[/uploads/:id](#get_uploads)		|GET |获取附件信息
25|[/accounts/:user_id](#acount)		|GET |获取账户余额
26|[/accounts/:user_id/pay](#pay)	|PUT |支付,提现转到银联,成功调此接口修改账户余额
27|[/accounts/:user_id/buy](#buy)	|PUT |充值
28|[/accounts/:user_id/bill](#bill)	|GET |收支明细
29|[/message/sms](#sms)				|POST|推送短信
30|[/message/app](#app)				|POST|app推送
31|[/message/weixin](#weixin)		|POST|微信推送，小黑板
32|[/message](#message)				|GET |获取推送信息列表
33|[/comments/](#add_comments)		|POST|添加评论
34|[/comments/](#list_comments)		|GET |获取评论列表
35|[/comments/:id](#update_comments)|PUT |修改评论
36|[/comments/:id](#get_comments)	|GET |获取评论信息
37 |[/policys/](#add_policys)		|POST|生成保单
38|[/policys/](#list_policys)		|GET |获取保单列表
39|[/policys/:id](#update_policys)	|PUT |修改保单
40|[/policys/:id](#get_policys)		|GET |获取保单信息
41|[/policys/:id/check](#check_policys)|PUT |审核保单
41|[/mail/](#mail)					|POST |发送保单邮件



###2. 接口设计
#### 1. <b id="activate">用户激活</b>

|方法名称|/users/activate|
|:----|:--------|
|请求方式|POST|

|参数名称|可空|说明|
|:--|:--------|
|contact_number|N|联系人电话，默认为login_name,目前的Login_name为手机号码|
|contact_name|N|联系人姓名|
|company||公司名称|
|address||联系地址|
|memo||个人说明档|

说明:
<font color="red">

	login_name 从token中获取	
</font>

返回数据:
>
	{
		"success":true
	}

#### 2. <b id="update_users">用户信息修改</b>

|方法名称|/users/:id|
|:----|:--------|
|请求方式|PUT|

|参数名称|可空|说明|
|:--|:--------|
|contact_number||手机|
|contact_name||联系人姓名|
|company||公司名称|
|address||联系地址|
|memo||个人说明档|

返回数据:
>
	{
		"success":true
	}


		
#### 3. <b id="get_users">获取用户信息</b>

|方法名称|/users/:id|
|:----|:--------|
|请求方式|GET|

返回数据:
>
	{
		"success":true,
		"result":{
			"login_name":"13812345678",//登录名为手机号，全局唯一
			"contact_number":"13812345678" ,//联系电话，默认与登录名一致
			"contact_name":"张三" ,//联系人姓名
			“company”:"杭州米阳科技有限公司" ,//公司名称
			“address”:"杭州市拱墅区北部软件园D区202室",//地址
			"memo":"这个家伙很懒，什么都没有留下"  //个人说明
		}
	}


#### 4. <b id="token">获取token</b>

|方法名称|/users/token|
|:----|:--------|
|请求方式|GET|

|参数名称|可空|说明|
|:--|:--------|
|contact_number||登录名，DES加密,暂时将密钥写在程序中|
|access_type||访问类型,1接口访问,2用户访问|

1. 此接口不传入token时,返回用户登录token
2. 此接口的请求头中有token时,根据此token返回用户信息
2. 本接口只允许指定的IP地址可以访问

		允许的IP地址列表写在配置文件中。
		访问本接口时，先获取请求的IP，判断访求的IP地址是否在允许的IP地下去列表中，
		如果不在列表中，返回错误信息，
			错误编码为001，
			错误信息为"访问者IP地址未经授权"。 
		并将该次访问的IP,contact_number,时间，接口名称写到 数据库 log_danger 表中。

返回数据:当访问类型=1时,只返回token,当访问类型=2时,同时返回用户信息

access_type==1

>
	{
		"success":true,
		"token":"token字符串"
	}

access_type==2
>
	{
		"success":true,
		"token":"token字符串"
		"user":
			{
				"user_id":123,
				"user_name":"abc",
				"contact_number":"13012345678",
				"contact_name":"联系人姓名",
				"login_name":"13012345678	"
				"is_admin":0,
				"memo":"备注信息"
			}
	}
	

#### 5. <b id="add_cargos">添加货源</b>

|方法名称|/cargos|
|:----|:--------|
|请求方式|POST|

|参数名称|可空|说明|
|:--|:--------|
|origin|N|启运地|
|destination|N|抵达地|
|origin_code||启运地编码|
|destination_code||抵达地编码||
|budget||参考运费|
|carriage||实际运费|
|longitude||货源经度|
|latitude||货源纬度|
|publish_time||发布时间|
|expired_time||过期时间|
|type||货源类型，1普货，2重货，3抛货|
|weight|| 重量，吨|
|volume|| 体积，立方米|
|packages|| 件数|
|receiver_name|| 收货方联系人姓名|
|receiver_number|| 收货方联系人电话|
|sender_name|| 发货方联系人姓名|
|sender_number|| 发货方联系人电话|
|status|| 发货单状态,0作废,10待成交,20待确认,99已成交|
|voice|| 语音留言，记录文件url|
|memo|| 其它说明|

返回数据:
>
	{
		"success":true,
		"result":{
			id:123	//增加的货源 id
		}
	}